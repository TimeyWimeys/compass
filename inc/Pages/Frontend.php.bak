<?php
/**
 * @package CompassPlugin
 */

namespace CompassPlugin\Pages;

use CompassPlugin\Base\BaseController;

class Frontend extends BaseController
{
    public function register()
    { 
      // Shortcodes
      add_action('init', array($this, 'set_shortcodes'));

      if ( cbn_fs()->is__premium_only() ):
        if ( cbn_fs()->can_use_premium_code() ):

          //PRO: Add user location within registration
          if(get_option('cbn_enable_add_user_location')):
            add_action('register_form', array($this, 'render_block_add_user_location__premium_only'));
            add_action('user_register', array($this, 'add_user_location__premium_only'));
          endif;

        endif;
      endif;
    }

    /**
     * Setup Shortcodes
     */
    public function set_shortcodes()
    {
      // EXIT if inside Elementor Backend
      // Check if Elementor installed and activated
		  if ( did_action( 'elementor/loaded' ) ) {

        if(\Elementor_cbn_Addon\Plugin::is_elementor_backend()) {
            error_log('OUM: prevented shortcode rendering inside Elementor');
            return;
        }

      }

      // Render Map
      add_shortcode('Compass', array($this, 'render_block_map'));

      //PRO: Render Image Gallery (Shortcode)
      if ( cbn_fs()->is__premium_only() ):
        if ( cbn_fs()->can_use_premium_code() ):

          add_shortcode('Compass-gallery', array($this, 'render_block_gallery__premium_only'));

        endif;
      endif;

      //PRO: Render Location Value (Shortcode)
      if ( cbn_fs()->is__premium_only() ):
        if ( cbn_fs()->can_use_premium_code() ):

          add_shortcode('Compass-location', array($this, 'render_block_location__premium_only'));

        endif;
      endif;

      //PRO: Render Locations List  (Shortcode)
      if ( cbn_fs()->is__premium_only() ):
        if ( cbn_fs()->can_use_premium_code() ):

          add_shortcode('Compass-list', array($this, 'render_block_list__premium_only'));

        endif;
      endif;

      // Whitelisting OUM scripts for Complianz plugin
      add_filter( 'script_loader_tag', function ( $tag, $handle, $source ) {

        if ( stristr($handle, 'oum') ) {
            $tag = '<script src="' . $source . '" data-category="functional" class="cmplz-native" id="' . $handle . '-js"></script>';
        }

        return $tag;
      }, 10, 3 );

      // Prevent shortcode parsing by All In One SEO plugin
      add_filter( 'aioseo_disable_shortcode_parsing', '__return_true' );

      // Prevent shortcode parsing by Slim SEO plugin
      add_filter( 'slim_seo_skipped_shortcodes', function( $shortcodes ) {
        $shortcodes[] = 'Compass';
        $shortcodes[] = 'Compass-location';
        $shortcodes[] = 'Compass-gallery';
        $shortcodes[] = 'Compass-list';
        return $shortcodes;
      } );

      // Prevent block parsing by Slim SEO plugin
      add_filter( 'slim_seo_skipped_blocks', function( $blocks ) {
        $blocks[] = 'Compass/map';
        return $blocks;
      } );

    }
}
